##############################################################################
# Splunk Universal Forwarder - transforms.conf
# DGX Spark Field Extraction Configuration
# Deploy to: $SPLUNK_HOME/etc/system/local/transforms.conf
##############################################################################

#=============================================================================
# DCGM Metrics Field Extraction
#=============================================================================

[dcgm_extract_fields]
REGEX = gpu=(\d+)\s+utilization=(\d+)\s+temperature=(\d+)\s+power_usage=(\d+\.?\d*)\s+fb_memory_used=(\d+)\s+fb_memory_free=(\d+)\s+sm_clock=(\d+)\s+mem_clock=(\d+)\s+pcie_tx=(\d+)\s+pcie_rx=(\d+)
FORMAT = gpu::$1 gpu_utilization::$2 temperature::$3 power_usage::$4 fb_memory_used::$5 fb_memory_free::$6 sm_clock::$7 mem_clock::$8 pcie_tx_throughput::$9 pcie_rx_throughput::$10

#=============================================================================
# NVIDIA-SMI Field Extraction
#=============================================================================

[nvidia_smi_extract]
REGEX = (\d+),\s*([^,]+),\s*(\d+)\s*%,\s*(\d+)\s*MiB\s*/\s*(\d+)\s*MiB,\s*(\d+)\s*%,\s*(\d+)C,\s*(\d+\.?\d*)\s*W
FORMAT = gpu_index::$1 gpu_name::$2 gpu_utilization::$3 memory_used_mib::$4 memory_total_mib::$5 memory_utilization::$6 temperature_c::$7 power_draw_w::$8

[nvidia_smi_fields]
REGEX = gpu_uuid=([A-Z0-9-]+)
FORMAT = gpu_uuid::$1

#=============================================================================
# Spark Log Level Extraction
#=============================================================================

[spark_log_level]
REGEX = ^\d{4}-\d{2}-\d{2}\s\d{2}:\d{2}:\d{2}\s+(INFO|WARN|ERROR|DEBUG|TRACE)\s+\[([^\]]+)\]\s+([^:]+):\s+(.*)
FORMAT = log_level::$1 thread::$2 class::$3 message::$4

#=============================================================================
# vLLM Request Field Extraction
#=============================================================================

[vllm_request_fields]
REGEX = request_id=([^\s]+)\s+model=([^\s]+)\s+prompt_tokens=(\d+)\s+completion_tokens=(\d+)\s+latency_ms=(\d+\.?\d*)\s+tokens_per_sec=(\d+\.?\d*)
FORMAT = request_id::$1 model::$2 prompt_tokens::$3 completion_tokens::$4 latency_ms::$5 tokens_per_sec::$6

#=============================================================================
# Docker Container Name Extraction
#=============================================================================

[docker_container_name]
REGEX = /var/lib/docker/containers/([a-f0-9]+)/
FORMAT = container_id::$1
DEST_KEY = MetaData:Host
SOURCE_KEY = source

#=============================================================================
# Kubernetes Pod/Namespace Extraction
#=============================================================================

[kube_pod_namespace]
REGEX = /var/log/pods/([^/]+)_([^/]+)_([^/]+)/([^/]+)/
FORMAT = namespace::$1 pod_name::$2 pod_uid::$3 container_name::$4

#=============================================================================
# XID Error Extraction (GPU Errors)
#=============================================================================

[nvidia_xid_errors]
REGEX = NVRM:\s+Xid\s+\(PCI:([^)]+)\):\s+(\d+),
FORMAT = pci_address::$1 xid_code::$2

#=============================================================================
# NVLink Error Extraction
#=============================================================================

[nvlink_errors]
REGEX = NVLink:\s+(\w+)\s+error\s+on\s+GPU\s+(\d+)\s+link\s+(\d+)
FORMAT = error_type::$1 gpu_id::$2 nvlink_id::$3
